app: virtual-registry-management

images:
  vrm: Zillaforge/virtual-registry-management:0.0.6
  debugger: Zillaforge/debugger:1.0.2
  eventpublishPlugin: Zillaforge/event-publish-plugin:0.1.2
  #filebeat: 10.247.4.4:80/trusted-cloud/filebeat:8.14.3

core:
  enabled: true
  configmap:
    version: 0.0.6
    kind: VirtualRegistryManagement
    VirtualRegistryManagement:
      instance: VirtualRegistryManagement-TrustCloud
      developer: true
      http:
        host: 0.0.0.0:8106
      grpc:
        host: 0.0.0.0:5106
        unix_socket: 
          path: /run/VirtualRegistryManagement.sock
          conn_count: 20
      logger:
        system_log:
          path: /var/log/ASUS/
          mode: debug
          show_in_console: true
        access_log:
          path: /var/log/ASUS/
        event_consume_log:
          path: /var/log/ASUS/
      tracer:
        enable: false
        host: http://jaeger-service:14268/api/traces
        timeout: 10
      # scopes:
      #   project_default_count: 10
      #   project_default_size: 1099511627776
      #   availability_district: "tw-tc-ad1"
      #   snapshot_size: "metadata.actual_size"
      filepath: 
      # <scheme>://<path> => <root>/<prefix>/<path>/<suffix>
      - name: dss-public-trustedcloud
        scheme: dss-public
        type: local
        root: /trusted-cloud/normal/storage
        prefix: "%s" # project-id
      - name: dss-private-trustedcloud
        scheme: dss-private
        type: local
        root: /trusted-cloud/sensitivity/storage
        prefix: "%s" # project-id
      - name: sss-trustedcloud
        scheme: sss
        type: local
        root: /trusted-cloud/normal/site-storage
        prefix: "%s" # project-id
    storage:
      provider: mariadb
      mariadb:
        host: mariadb-galera:3306
        account: root
        password: password
        name: vrm
        timeout: 5
        max_open_conns: 150
        conn_max_lifetime: 10
        max_idle_conns: 150
    vps:
      host: vps-service:5110
      tls:
        enable: false
        cert_path: /root/server-csr/IAM.pem
      connection_per_host: 3
    authentication:
      service: myiam
    openstack:
      - namespace: public
        service: opstk
      - namespace: private
        service: opstk
    event_consume:
      service: my_redis_sentinel
      channels:
      - FromIAM
    services:
      - name: myiam
        kind: iam
        hosts:
          - iam-service:5051
        tls:
          enable: false
          cert_path: /root/server-csr/IAM.pem
        connection_per_host: 3
      - name: my_redis_sentinel
        kind: redis_sentinel
        hosts:
        - redis-sentinel-service:26379
        password: password
        master_group_name: mymaster
      - name: opstk
        kind: openstack
        identity_endpoint: http://192.168.0.200:5000 #openstakc keystone endpoint
        username: test@trusted-cloud.nchc.org.tw
        password: password123
        domain_name: trustedcloud
        admin_project: 14735dfa-5553-46cc-b4bd-405e711b223f #trustedcloud
        allow_reauth: true
        pid_source: extra.tw-tc-ad1.opsk.uuid 
    event_publish:
      plugins:
      - name: EventPublishPlugin
        type: grpc
        binary_path: "/var/lib/ASUS/vrm/eventpublish/eventpublishplugin"
        config_path: "/var/lib/ASUS/vrm/eventpublish/config/eventpublishplugin.yaml"
        socket_path: /run/eventpublishplugin.sock
        start_cmd_args:
          --redis-channel: FromVRM
    # littlebell: 
    #   host: http://simple-notification-service-service:8092
    #   region: default
    #   credential:
    #     project_id: 14735dfa-5553-46cc-b4bd-405e711b223f
    #     user_id: 4990ccdb-a9b1-49e5-91df-67c921601d81
    #   arn: []
    metering_service: 
      account: user
      password: password
      host: rabbitmq:5672
      manage_host: rabbitmq:15672
      timeout: 5
      rpc_timeout: 10
      vhost: "/"
      operation_connection_num: 2
      channel_num: 1
      replica_num: 0
      consumer_connection_num: 1


scheduler:
  enabled: true
  configmap:
    version: 0.0.6
    kind: VirtualRegistryManagementScheduler
    VirtualRegistryManagementScheduler:
      instance: VirtualRegistryManagementScheduler-TrustCloud
      core_grpc:
        hosts: ["virtual-registry-management-core-service:5106"]
        tls:
          enable: false 
          cert_path: /root/server-csr/VRM.pem
        connection_per_host: 3
      tasks:
        sync_projects:
          cron_expression: "0 */10 * * * * *"
        sync_tags:
          cron_expression: "0 */10 * * * * *"
        sync_exports:
          cron_expression: "0 * * * * * *"
        size_hard_limited_exceed:
          cron_expression: "0 */10 * * * * *"
        count_hard_limited_exceed:
          cron_expression: "0 */10 * * * * *"
        image_size:
          cron_expression: "0 0 * * * * *"
          metering_service:
            exchange: mts
            routing_key: "vrm-image-size"
        image_count:
          cron_expression: "0 0 * * * * *"
          metering_service:
            exchange: mts
            routing_key: "vrm-image-count"
    event_consume:
      service: my_redis_sentinel
      channels:
      - FromIAM

eventpublish:
  eventpublishPlugin:
    plugin:
      name: EventPublishPlugin
      instance: VirtualRegistryManagement-EventPublishPlugin-TrustCloud
      version: 0.1.2
      socket_path: "/run/eventpublishplugin.sock"
      logger:
        system_log:
          path: /var/log/ASUS
          max_size: 10
          max_backups: 5
          max_age: 10
          compress: false
          mode: debug
          show_in_console: true
        event_log:
          path: /var/log/ASUS
          max_size: 10
          max_backups: 5
          max_age: 10
      tracer:
        enable: false
        collector_endpoint: http://jaeger-service:14268/api/traces
        timeout: 10
      service: my_redis_sentinel
      services:
      - name: my_redis_sentinel
        kind: redis_sentinel
        hosts:
        - redis-sentinel-service:26379
        password: password
        master_group_name: mymaster

service:
  core:
    enableNodePort: true
    externalIPs: []
    grpc:
      port: 5106
      nodePort: 31106
    http:
      port: 8106
      nodePort: 32106

volumes: #因為都在Local建立，所以要在本機設定好路徑
  - name: dss-public-trustedcloud
    type: local
    path: /trusted-cloud/normal/storage
    mount_path: /trusted-cloud/normal/storage
  - name: dss-private-trustedcloud
    type: local
    path: /trusted-cloud/sensitivity/storage
    mount_path: /trusted-cloud/sensitivity/storage
  - name: sss-trustedcloud
    type: local
    path: /trusted-cloud/normal/site-storage
    mount_path: /trusted-cloud/normal/site-storage

serviceMonitor:
  enable: false

# elasticSearch:
#   hosts: ["https://10.247.4.7:9200","https://10.247.4.8:9200","https://10.247.4.9:9200"]
#   index: accesslog-%{[service.auditLogName]}
#   protocol: "https"
#   pipeline: pipeline-%{[service.auditLogName]}
#   preset: balanced
#   username: "elastic"
#   password: "password"
#   ssl:
#     enabled: false
#     verification_mode: none